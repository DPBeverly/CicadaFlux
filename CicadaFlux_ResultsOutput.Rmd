---
title: "R CicadaFlux Analysis"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

# Cicada Flux Measurements from 2021

### Two Questions are developed on how cicada emergene influences soil respiration and carbon fluxes:

#### *__1)__* To what extent do periodical cicada emergence holes influence soil CO2 efflux? Are responses variable across species or mycorrhizal fungal types?

#### *__2)__* What levels of disruption to ecosystem scale respiration can be attributed to periodical cicada emergence hole densities?
  
  
  
#####        Mechanistic hypothesis: 
  
  
  
![Conceptual model of competing mechansisms influencing soil respiration following cicada emergence. Nymph cicadas form holes aerating soils **(a))** increasing aerobic conditions in the soils increasing both autotrophic (Ra) and heterotropic respiration (Rh). Conversely, emergence holes also increase infiltration **(b))** reducing CO2 and oxygen diffusion potential creating anaerobic conditions. Subsequent conditions result in elevated CH4 efflux.  ](D:/Dropbox/Projects/Indiana/Data/CicadaFlux/CicadaConceptualFigure.png)

  
  


```{r echo=FALSE, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
##//Data managmenet for MiniMet Systems at MMSF in conjunction with Sapflux and stem psychrometers
###///This script is ugly and brute force but is functional, will be converted to a loop based approach prior to publication
##//Package management
library(readxl)
library(ggplot2)
library(tidyverse)
library(lubridate)
library(hutils)
library(brms)
library(modelr)
library(sjPlot)
library(sjstats)
library(RColorBrewer)
library(tidybayes)
library(dplyr)
library(tidyr)
library(tidyselect)
library(stringr)
library(gridExtra)

theme_set(theme_classic())
GoAvsGo <- c("#6F263D", "#236192", "#A2AAAD", "#000000")


##//Where is the data
setwd("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/SoilFlux/RawData")


##//List of files in the directory
Flist <- dir(pattern = ".81x")

##//Complied dataframe
DOut <- data.frame()
Fdat <- data.frame()
#for(j in 1:length(Flist)){
##//Reading in the files by lines so that we can rip apart the irregular vetor formats

for(k in 1:length(Flist)){
text <- readLines(Flist[k])
#length(Flist)
##//Pulling meta data and results
maybe <-  text %>% 
  enframe(name = NULL) %>%
  filter(str_detect(value, "^.")) %>%   ##// Regular expression grabbing infromation for each line with two  vectors 
  separate(value, sep = "\t", into = c("Parameter", "Value"))

##//LiCor Data and Meta data
LiCor_dat <- data.frame(File = maybe$Value[maybe$Parameter=="File Name:"],
                        Collar = maybe$Value[maybe$Parameter=="Comments:"],
                        Obs = as.numeric(maybe$Value[maybe$Parameter=="Obs#:"]),
                        VCham = as.numeric(maybe$Value[maybe$Parameter=="Vcham:"]), 
                        Offset = as.numeric(maybe$Value[maybe$Parameter=="Offset:"]),
                        Area = as.numeric(maybe$Value[maybe$Parameter=="Area:"]),
                        VTotal = as.numeric(maybe$Value[maybe$Parameter=="Vtotal:"]),
                        FitStatus = maybe$Value[maybe$Parameter=="CrvFitStatus:"],
                        ExpFlux = as.numeric(maybe$Value[maybe$Parameter=="Exp_Flux:"]),
                        ExpFluxCV = as.numeric(maybe$Value[maybe$Parameter=="Exp_FluxCV:"]),
                        Exp_dCdt = as.numeric(maybe$Value[maybe$Parameter=="Exp_dCdry/dt:"]),
                        ExpR2 = as.numeric(maybe$Value[maybe$Parameter=="Exp_R2:"]),
                        LinFlux = as.numeric(maybe$Value[maybe$Parameter=="Lin_Flux:"]),
                        LinFluxCV = as.numeric(maybe$Value[maybe$Parameter=="Lin_FluxCV:"]),
                        Lin_dCdt = as.numeric(maybe$Value[maybe$Parameter=="Lin_dCdry/dt:"]),
                        LinR2 = as.numeric(maybe$Value[maybe$Parameter=="Lin_R2:"]),
                        LinFluxSE = as.numeric(maybe$Value[maybe$Parameter=="Lin_SE:"]))

###//Raw fluxes to long format dataframe
maybeData <-  text %>% 
  enframe(name = NULL) %>%
  filter(str_detect(value, "^\\d")) %>%  ##// Regular expression searching for start of line begining with a number 
  separate(value, sep = "\t", into = c("Type",	"Etime",	"Date",	"Tcham",	"Pressure",	"H2O", "CO2",	"Cdry",	"Tbench",	"RH",	"Tboard",	"Vin",
                                       "CO2ABS",	"H2OABS",	"Hour", "DOY", "RAWCO2", "RAWCO2REF",	"RAWH2O",	"RAWH2OREF"))

##//Updating the classes
maybeData$Date_ct <- as.POSIXct(strptime(maybeData$Date, format = "%Y-%m-%d %H:%M:%S"), tz="EST")
maybeData$Type <- as.numeric(maybeData$Type); maybeData$Etime <- as.numeric(maybeData$Etime); maybeData$Tcham <- as.numeric(maybeData$Tcham);
maybeData$Pressure <- as.numeric(maybeData$Pressure); maybeData$H2O <- as.numeric(maybeData$H2O); maybeData$CO2 <- as.numeric(maybeData$CO2);
maybeData$Cdry <- as.numeric(maybeData$Cdry); maybeData$Tbench <- as.numeric(maybeData$Tbench); maybeData$RH <- as.numeric(maybeData$RH);
maybeData$Tboard <- as.numeric(maybeData$Tboard); maybeData$Vin <- as.numeric(maybeData$Vin); maybeData$CO2ABS <- as.numeric(maybeData$CO2ABS);
maybeData$H2OABS <- as.numeric(maybeData$H2OABS); maybeData$Hour <- as.numeric(maybeData$Hour); maybeData$DOY <- as.numeric(maybeData$DOY);
maybeData$RAWCO2 <- as.numeric(maybeData$RAWCO2); maybeData$RAWCO2REF <- as.numeric(maybeData$RAWCO2REF);
maybeData$RAWH2O <- as.numeric(maybeData$RAWH2O); maybeData$RAWH2OREF <- as.numeric(maybeData$RAWH2OREF);


##//Reconstructing data to be in long format 
##//Using time of last measurement to seperate observations
endMes <- maybeData$Date_ct[maybeData$Type==4]


tests <- maybeData[maybeData$Date_ct<=endMes[1],]
tests$Collar <- LiCor_dat$Collar[1]
tests$File <- LiCor_dat$File[1]
tests$OBS <- LiCor_dat$Obs[1]
tests$VCham <- LiCor_dat$VCham[1]
tests$Offset <- LiCor_dat$Offset[1]
tests$Area <- LiCor_dat$Area[1]
tests$VTotal <- LiCor_dat$VTotal[1]
tests$ExpFlux <- LiCor_dat$ExpFlux[1]
tests$ExpFluxCV <- LiCor_dat$ExpFluxCV[1]
tests$Exp_dCdt <- LiCor_dat$Exp_dCdt[1]
tests$ExpR2 <- LiCor_dat$ExpR2[1]
tests$LinFlux <- LiCor_dat$LinFlux[1]
tests$LinFluxCV <- LiCor_dat$LinFluxCV[1]
tests$Lin_dCdt <- LiCor_dat$Lin_dCdt[1]
tests$LinR2 <- LiCor_dat$LinR2[1]
tests$LinFluxSE <- LiCor_dat$LinFluxSE[1]

DOut <- rbind(DOut, tests)

for(i in 2:length(endMes)){
  
  tests <- maybeData[maybeData$Date_ct<=endMes[i] & maybeData$Date_ct>endMes[i-1],]
  tests$Collar <- LiCor_dat$Collar[i]
  tests$File <- LiCor_dat$File[i]
  tests$OBS <- LiCor_dat$Obs[i]
  tests$VCham <- LiCor_dat$VCham[i]
  tests$Offset <- LiCor_dat$Offset[i]
  tests$Area <- LiCor_dat$Area[i]
  tests$VTotal <- LiCor_dat$VTotal[i]
  tests$ExpFlux <- LiCor_dat$ExpFlux[i]
  tests$ExpFluxCV <- LiCor_dat$ExpFluxCV[i]
  tests$Exp_dCdt <- LiCor_dat$Exp_dCdt[i]
  tests$ExpR2 <- LiCor_dat$ExpR2[i]
  tests$LinFlux <- LiCor_dat$LinFlux[i]
  tests$LinFluxCV <- LiCor_dat$LinFluxCV[i]
  tests$Lin_dCdt <- LiCor_dat$Lin_dCdt[i]
  tests$LinR2 <- LiCor_dat$LinR2[i]
  tests$LinFluxSE <- LiCor_dat$LinFluxSE[i]
  
  
  DOut <- rbind(DOut, tests)
  
  
}

Fdat <- rbind(Fdat, DOut)

}

#############################################################################################################
#############################################################################################################
#str(Fdat)
#testCSV <- write.csv(Fdat, "CicadaFluxOut.csv")
Fdat$UnqMeas <- as.character(paste(Fdat$File, Fdat$Collar, sep = "_"))
MyMeas <- unique(Fdat$UnqMeas)
class(Fdat$UnqMeas)
length(MyMeas)
##//Remove burn-in data
Rs_RData_raw <- as.data.frame(Fdat[Fdat$Etime>5 & Fdat$Etime<=110,])

i = 2
f = 3

dCdt_frame <- data.frame()

for(i in 1:length(MyMeas)){
  ##//Simple linear regression
  DcDt_mod <- lm(Rs_RData_raw$Cdry[Rs_RData_raw$UnqMeas==MyMeas[i]]~Rs_RData_raw$Etime[Rs_RData_raw$UnqMeas==MyMeas[i]] )
  
  ##//R2 for model fits
  LIN_R2 <- summary(DcDt_mod)$r.squared
  
  ##//Model Coeffecients
  INT_CO2 <- DcDt_mod$coefficients[1]
  dCdtm <- DcDt_mod$coefficients[2]
  
  ##//Cred Intervals
  INT_CO2_LCI <- confint(DcDt_mod)[1]
  INT_CO2_HCI <- confint(DcDt_mod)[3]
  dCdt_LCIm <-  confint(DcDt_mod)[2]
  dCdt_HCIm <-  confint(DcDt_mod)[4]
  
  dCdt_frame <- rbind(dCdt_frame, data.frame(File = Rs_RData_raw$File[Rs_RData_raw$UnqMeas==MyMeas[i]][1],
                                             Collar = Rs_RData_raw$Collar[Rs_RData_raw$UnqMeas==MyMeas[i]][1],
                                             LinReg_R2 = LIN_R2,
                                             CO2_t0 = INT_CO2,
                                             CO2_t0_LCI = INT_CO2_LCI,
                                             CO2_t0_HCI = INT_CO2_HCI,
                                             dCdt = dCdtm,
                                             dCdt_LCI = dCdt_LCIm,
                                             dCdt_HCI = dCdt_HCIm))
  
}


dCdt_frame

dCdt_frame$UnqMeas <- as.character(paste(dCdt_frame$File, dCdt_frame$Collar, sep = "_"))


Rs_RData_sum <- Rs_RData_raw %>%
  dplyr::mutate(day = as.Date(Date_ct, format="%d-%m-%Y")) %>%
  dplyr::group_by(day, UnqMeas) %>% # group by the day column ##//mean looks good
  dplyr::summarise_if(is.numeric, median, na.rm = TRUE) %>%  
  na.omit

Rs_RData_sum <- inner_join(Rs_RData_sum, dCdt_frame, by = "UnqMeas")

Rs_Mdata <- read.csv("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/RespMetaData.csv")
Rs_Sdata <- read.csv("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/SoilTempMoisture/SoilT_VWC_CicadaFlux_2021.csv")

Rs_Sdata <- Rs_Sdata %>%
  dplyr::mutate(day = as.Date(Rs_Sdata$Date, format="%m/%d/%Y"))

Rs_data <- inner_join(Rs_RData_sum, Rs_Sdata, by = c("day", "Collar"))
Rs_data <- inner_join(Rs_data, Rs_Mdata, by = c("Site", "Collar"))

###//Recalculate the fluxes

R <- 8.314 #Pa m3 K-1 mol-1

Rs_data$VCollar <- Rs_data$Corr_offset_cm * Rs_data$Area

Rs_data$Corr_VTotal <- Rs_data$VCollar + Rs_data$VCham


Rs_data$Corr_LinFlux <- (10 * Rs_data$Corr_VTotal * Rs_data$Pressure * (1 - Rs_data$H2O / 10000)) /   
  ( R * Rs_data$Area * (Rs_data$Tcham +273.15)) * Rs_data$dCdt


Rs_data$Corr_LinFlux_LCI <- (10 * Rs_data$Corr_VTotal * Rs_data$Pressure * (1 - Rs_data$H2O / 10000)) /   
  ( R * Rs_data$Area * (Rs_data$Tcham +273.15)) * Rs_data$dCdt_LCI

Rs_data$Corr_LinFlux_HCI <- (10 * Rs_data$Corr_VTotal * Rs_data$Pressure * (1 - Rs_data$H2O / 10000)) /   
  ( R * Rs_data$Area * (Rs_data$Tcham +273.15)) * Rs_data$dCdt_HCI

Rs_plots <- Rs_data[Rs_data$LinReg_R2>=0.85 & Rs_data$Corr_LinFlux>0,]

length(Rs_data$UnqMeas[Rs_data$LinReg_R2<0.85])
length(Rs_data$UnqMeas[Rs_data$LinReg_R2>=0.85])

353/(90+353)

```

  

#### Seasonal Trends in soil temperature and moisture
```{r fig.asp = 0.9, fig.width = 15, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

result <- data.frame(
  Rs_plots$day,
  cut_Date = cut(as.Date(Rs_plots$day), "week"),
  cut_POSIXt = cut(as.POSIXct(Rs_plots$day), "week"),
  stringsAsFactors = FALSE)

Rs_plots$Week <- result$cut_POSIXt

Ts_Time <- ggplot() +
  geom_boxplot(data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
               aes(x = Week, y = SoilT_C), color = "black", 
               show.legend = TRUE,  size = 1, alpha = 0.4, 
               notch = TRUE, notchwidth = 0.5) +
  scale_color_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  scale_fill_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  #xlab('Date') +
  ylab(expression(paste("Soil Temperature [C]" ))) +
  annotate("text", x = Rs_plots$Week[1], y = 26, label = "a)    ", size = 20) +
  theme(legend.position="NA",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species",size=30),
        legend.text=element_text(size=30),
        #axis.text.x = element_text(angle = 45, vjust = 0.8, hjust=0.7),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.x = element_blank())

VWC_Time <- ggplot() +
  geom_boxplot(data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
               aes(x = Week, y = SoilVWC_pct), color = "black", 
               show.legend = TRUE,  size = 1, alpha = 0.4, 
               notch = TRUE, notchwidth = 0.5) +
  scale_color_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  scale_fill_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
 # xlab('Date') +
  ylab(expression(paste("Soil Moisture [% VWC]" ))) +
  annotate("text", x = Rs_plots$Week[1], y = 70, label = "b)    ", size = 20) +
  theme(legend.position="NA",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species",size=30),
        legend.text=element_text(size=30),
        #axis.text.x = element_text(angle = 45, vjust = 0.8, hjust=0.7),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.x = element_blank())

Flux_Time <- ggplot() +
  geom_boxplot(data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
               aes(x = Week, y = Corr_LinFlux), color = "black", 
               show.legend = TRUE,  size = 1, alpha = 0.4, 
               notch = TRUE, notchwidth = 0.5) +
  scale_color_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  scale_fill_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  xlab('Date') +
 # ylab(expression(paste("Soil Efflux  [", mu, "mol CO" [2], " m"^2, "  s "^-1, "] "  ))) +
  ylab(expression(paste("R" ["S"] , " [",mu, "mol " , " CO" ["2"], "  m"^"-2 ", "s"^"-1", "]"))) +
  annotate("text", x = Rs_plots$Week[1], y = 7, label = "c)    ", size = 20) +
  theme(legend.position="NA",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species",size=30),
        legend.text=element_text(size=30),
        axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=0.7))
Flux_Time


##Put plots together
grid.arrange(
  Ts_Time,
  VWC_Time,
  Flux_Time,
  ncol = 1,
  nrow = 3,
  respect = FALSE,
  clip = FALSE
)




Ts_Time2 <- ggplot() +
  geom_boxplot(data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
               aes(x = Week, y = SoilT_C), color = "black", 
               show.legend = TRUE,  size = 1, alpha = 0.4, 
               notch = F, notchwidth = 0.5) +
  scale_color_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  scale_fill_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  #xlab('Date') +
  ylab(expression(paste("Soil Temperature [C]" ))) +
  annotate("text", x = Rs_plots$Week[1], y = 26, label = "a)    ", size = 20) +
  theme(legend.position="NA",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species",size=30),
        legend.text=element_text(size=30),
        axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=0.7))
Ts_Time2

VWC_Time2 <- ggplot() +
  geom_boxplot(data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
               aes(x = Week, y = SoilVWC_pct), color = "black", 
               show.legend = TRUE,  size = 1, alpha = 0.4, 
               notch = F, notchwidth = 0.5) +
  scale_color_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  scale_fill_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
 # xlab('Date') +
  ylab(expression(paste("Soil Moisture [% VWC]" ))) +
  annotate("text", x = Rs_plots$Week[1], y = 70, label = "b)    ", size = 20) +
  theme(legend.position="NA",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species",size=30),
        legend.text=element_text(size=30),
        axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=0.7))
VWC_Time2

Flux_Time2 <- ggplot() +
  geom_boxplot(data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
               aes(x = Week, y = Corr_LinFlux), color = "black", 
               show.legend = TRUE,  size = 1, alpha = 0.4, 
               notch = F, notchwidth = 0.5) +
  scale_color_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  scale_fill_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  xlab('Date') +
 # ylab(expression(paste("Soil Efflux  [", mu, "mol CO" [2], " m"^2, "  s "^-1, "] "  ))) +
  ylab(expression(paste("R" ["S"] , " [",mu, "mol " , " CO" ["2"], "  m"^"-2 ", "s"^"-1", "]"))) +
  annotate("text", x = Rs_plots$Week[1], y = 7, label = "c)    ", size = 20) +
  theme(legend.position="NA",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species",size=30),
        legend.text=element_text(size=30),
        axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=0.7))
Flux_Time2


##Put plots together
grid.arrange(
  Ts_Time,
  VWC_Time,
  Flux_Time,
  ncol = 1,
  nrow = 3,
  respect = FALSE,
  clip = FALSE
)


###
names(Rs_plots)

Rs_plots$SitePairs <- paste(Rs_plots$Site, Rs_plots$Pair, sep = "")



##//Wrote file and removed and observations that did not have complete set of paired collars
# write.csv(Rs_plots, "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/HolePlotDataframe.csv")

##//Modified file containing only paired observations
d_forHoleFig <- read.csv("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/HolePlotDataframe.csv")

Rs_plots_sum <- d_forHoleFig[d_forHoleFig$Corr_LinFlux<=6 & d_forHoleFig$Site!="KentFarm",] %>%
  #dplyr::mutate(day = as.Date(Date_ct, format="%d-%m-%Y")) %>%
  dplyr::group_by(Week, Symbiont) %>% # group by the day column ##//mean looks good
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%  
  na.omit

ggplot() +
  geom_boxplot(data = Rs_plots_sum, aes(x = as.factor(Week), y = n_holes), 
               show.legend = TRUE,  size = 1) +
  ylab(expression(paste("Mean Cicada Holes", "  collar"^"-1 "))) +
  xlab('Date') +
  theme(legend.position = "top",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species",size=30),
        legend.text=element_text(size=30),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))



Holes_Time <- ggplot() +
  geom_boxplot(data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
               aes(x = Week, y = n_holes), color = "black", 
               show.legend = TRUE,  size = 1, alpha = 0.4, 
               notch = F, notchwidth = 1) +
  scale_color_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  scale_fill_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  xlab('Date') +
 # ylab(expression(paste("Soil Efflux  [", mu, "mol CO" [2], " m"^2, "  s "^-1, "] "  ))) +
  ylab(expression(paste("R" ["S"] , " [",mu, "mol " , " CO" ["2"], "  m"^"-2 ", "s"^"-1", "]"))) +
  ##annotate("text", x = Rs_plots$Week[1], y = 7, label = "c)    ", size = 20) +
  ylim(-2,2) +
  theme(legend.position="NA",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species",size=30),
        legend.text=element_text(size=30),
        axis.text.x = element_text(angle = 45, vjust = 0.7, hjust=0.7))
Holes_Time


 Rs_plots$n_holes[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm"]
 Rs_plots$Hole_Collar[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm"]
 Rs_plots$Pair[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm"]
##// Export 1000 x 2000
Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",]

Quick_RData_sum <- Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",] %>%
  #dplyr::mutate(day = as.Date(Date_ct, format="%d-%m-%Y")) %>%
  dplyr::group_by(Week) %>% # group by the day column ##//mean looks good
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%  
  na.omit

Quick_RData_sd <- Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",] %>%
  #dplyr::mutate(day = as.Date(Date_ct, format="%d-%m-%Y")) %>%
  dplyr::group_by(Week) %>% # group by the day column ##//mean looks good
  dplyr::summarise_if(is.numeric, sd, na.rm = TRUE) %>%  
  na.omit

Quick_RData_sum$SoilT_C
Quick_RData_sum$SoilVWC_pct
mean(Quick_RData_sum$SoilVWC_pct[Quick_RData_sum$SoilVWC_pct<38])

Quick_RData_sum$Corr_LinFlux
Quick_RData_sd$Corr_LinFlux



Quick_RData_sumMMS <- Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site=="MorganMonroe",] %>%
  #dplyr::mutate(day = as.Date(Date_ct, format="%d-%m-%Y")) %>%
  dplyr::group_by(Week) %>% # group by the day column ##//mean looks good
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%  
  na.omit

Quick_RData_sdMMS <-Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site=="MorganMonroe",] %>%
  #dplyr::mutate(day = as.Date(Date_ct, format="%d-%m-%Y")) %>%
  dplyr::group_by(Week) %>% # group by the day column ##//mean looks good
  dplyr::summarise_if(is.numeric, sd, na.rm = TRUE) %>%  
  na.omit

Quick_RData_sumGW <- Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site=="GriffyWoods",] %>%
  #dplyr::mutate(day = as.Date(Date_ct, format="%d-%m-%Y")) %>%
  dplyr::group_by(Week) %>% # group by the day column ##//mean looks good
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%  
  na.omit

Quick_RData_sdGW <-Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site=="GriffyWoods",] %>%
  #dplyr::mutate(day = as.Date(Date_ct, format="%d-%m-%Y")) %>%
  dplyr::group_by(Week) %>% # group by the day column ##//mean looks good
  dplyr::summarise_if(is.numeric, sd, na.rm = TRUE) %>%  
  na.omit

Quick_RData_sumMMS$Corr_LinFlux
Quick_RData_sdMMS$Corr_LinFlux

Quick_RData_sumGW$Corr_LinFlux
Quick_RData_sdGW$Corr_LinFlux

douts <- Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",]
write.csv(douts, "D:/Dropbox/Projects/Indiana/Data/Zenodo/CicadaChamberFlux_2021.csv", row.names = F)


```

*Figure 1:* Soil temperature (**a)**) and moisture (**b)**) corresponding to soil respiration observations  (**c)**)  located at base of trees associated with arbuscular mycorrhizal and ectomycorrhizal fungi. Measurements represent weekly responses as soil respiration measurements were conducted on different days within the same week. 




```{r, echo=FALSE}
##//Uniformed Prior
# my.prior <- set_prior("uniform(-30000,30000)", class = "b")

####///Temperature model
# TS_mod1 <- brm(
#     SoilT_C ~ Week + Symbiont,
#     data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
#     prior = my.prior,
#     family =  "normal",
#     iter = 2000,
#     chains = 4,
#     cores = 4,
#     control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(TS_mod1, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/TS_mod1.rda")

##//Load Model output
load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/TS_mod1.rda")

###//Model Summaries 
summary(TS_mod1, prob = 0.89)
# bayes_R2(TS_mod1, prob = c(0.03, 0.97))
##//Model predictions
# plot_model(TS_mod1, type = "pred", terms = c("Week", "Symbiont"), show.data = TRUE) + 
#   theme_bw()

##//Post-hoc hypothesis testing
HypTS_mod1 = hypothesis(
  TS_mod1,
  hypothesis = c("Intercept = Intercept + SymbiontECM"))
HypTS_mod1

####///Soil Moisture model
# SM_mod1 <- brm(
#     SoilVWC_pct ~ Week + Symbiont,
#     data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
#     prior = my.prior,
#     family =  "normal",
#     iter = 2000,
#     chains = 4,
#     cores = 4,
#     control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(SM_mod1, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/SM_mod1.rda")
# rm(SM_mod1)
##//Load Model output
load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/SM_mod1.rda")

##//Model summaries
summary(SM_mod1, prob = 0.89)
# bayes_R2(SM_mod1, prob = c(0.03, 0.97))
##//Model predictions
# plot_model(SM_mod1, type = "pred", terms = c("Week", "Symbiont"), show.data = TRUE) +
#   theme_bw()

##//Post-hoc hypothesis testing
HypSM_mod1 = hypothesis(
  SM_mod1,
  hypothesis = c("Intercept = Intercept + SymbiontECM"))
HypSM_mod1

##//Post hoc tests
#get the adjusted means
SM_mod1_em <- emmeans(SM_mod1,  ~ Week)
SM_mod1_em

#get all possible contrasts
cont <- contrast(SM_mod1_em, "tukey")
cont

################################################
###//Testing Holes effect
Rs_plots$Hole_Collarf <- as.factor(Rs_plots$Hole_Collar)
####///Temperature model
# TS_mod2 <- brm(
#     SoilT_C ~ Week + Hole_Collarf,
#     data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
#     prior = my.prior,
#     family =  "normal",
#     iter = 2000,
#     chains = 4,
#     cores = 4,
#     control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(TS_mod2, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/TS_mod2.rda")

##//Load Model output
load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/TS_mod2.rda")

###//Model Summaries 
summary(TS_mod2, prob = 0.89)
# bayes_R2(TS_mod2, prob = c(0.03, 0.97))
##//Model predictions
# plot_model(TS_mod2, type = "pred", terms = c("Week", "Hole_Collarf"), show.data = TRUE) +
#   theme_bw()

##//Post-hoc hypothesis testing
HypTS_mod2 = hypothesis(
  TS_mod2,
  hypothesis = c("Intercept = Intercept + Hole_Collarf1"))
HypTS_mod2

##//Post hoc tests
#get the adjusted means
TS_mod2_em <- emmeans(TS_mod2,  ~ Week)
TS_mod2_em

#get all possible contrasts
cont <- contrast(TS_mod2_em, "tukey")
cont

####///Soil Moisture model
# SM_mod2 <- brm(
#     SoilVWC_pct ~ Week + Hole_Collarf,
#     data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
#     prior = my.prior,
#     family =  "normal",
#     iter = 2000,
#     chains = 4,
#     cores = 4,
#     control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(SM_mod2, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/SM_mod2.rda")
# rm(SM_mod1)
##//Load Model output
load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/SM_mod2.rda")

##//Model summaries
summary(SM_mod2, prob = 0.89)
# bayes_R2(SM_mod1, prob = c(0.03, 0.97))
##//Model predictions
# plot_model(SM_mod2, type = "pred", terms = c("Week", "Hole_Collarf"), show.data = TRUE) +
#   theme_bw()

##//Post-hoc hypothesis testing
HypSM_mod2 = hypothesis(
  SM_mod2,
  hypothesis = c("Intercept = Intercept + SymbiontECM"))
HypSM_mod2



```


#### Soil temperature and moisture among cicada holes
```{r fig.asp = 0.8, fig.width = 15, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
Ts_plot <- ggplot() +
  geom_boxplot(data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
               aes(x = as.factor(n_holes), y = SoilT_C, fill = as.factor(n_holes)), color = "black", 
               show.legend = TRUE, width = 0.5, size = 1, alpha = 0.4, position = position_dodge(0.5),
               notch = T, notchwidth = 0.95) +
  
  geom_violin(data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
               aes(x = as.factor(n_holes), y = SoilT_C, fill = as.factor(n_holes)), color = "black", trim = F,
               show.legend = TRUE,  size = 1, alpha = 0.25, position = position_dodge(0.5)) +
  scale_color_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  scale_fill_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  xlab('Number of Holes') +
  ylab(expression(paste("Soil Temperature [C]" ))) +
  annotate("text", x = as.factor(Rs_plots$n_holes[2]), y = 26, label = "a)    ", size = 20) +
  theme(legend.position="NA",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species",size=30),
        legend.text=element_text(size=30))
Ts_plot
VWC_plot <- ggplot() +
  geom_boxplot(data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
               aes(x = as.factor(n_holes), y = SoilVWC_pct, fill = as.factor(n_holes)), color = "black", 
                show.legend = TRUE, width = 0.5, size = 1, alpha = 0.4, position = position_dodge(0.5),
               notch = T, notchwidth = 0.95) +
    
  geom_violin(data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
               aes(x = as.factor(n_holes), y = SoilVWC_pct,fill =as.factor(n_holes)), 
              color = "black",trim = F,
              show.legend = TRUE,  size = 1, alpha = 0.25, position = position_dodge(0.5)) +
  scale_color_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  scale_fill_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  xlab('Number of Holes') +
  ylab(expression(paste("Soil Moisture [% VWC]" ))) +
  annotate("text", x = as.factor(Rs_plots$n_holes[2]), y = 70, label = "b)    ", size = 20) +
  theme(legend.position="NA",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species",size=30),
        legend.text=element_text(size=30))


##Put plots together
grid.arrange(
  Ts_plot,
  VWC_plot,
  ncol = 1,
  nrow = 2,
  # widths = c(3, 3),
  # heights = c(3),
  clip = FALSE
)


```
*Figure 2:* Soil temperature (**a)**) and moisture (**b)**) with respect to the number of cicada holes within the soil respiration collars. No significant differences were noted as collars were typically located within 30 cm of each other.



```{r fig.asp = 0.8, fig.width = 15, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
library(emmeans)
####///Rs models
##//Timeseries model
##//Random effect of site
# Rs_mod1 <- brm(
#     Corr_LinFlux ~ Week + Symbiont + (1|Site),
#     data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
#     prior = my.prior,
#     family =  "normal",
#     iter = 2000,
#     chains = 4,
#     cores = 4,
#     control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(Rs_mod1, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/Rs_mod1.rda")
# rm(Rs_mod1)
##//Load Model output
load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/Rs_mod1.rda")

##//Model summaries
summary(Rs_mod1, prob = 0.94)
# bayes_R2(Rs_mod1, prob = c(0.03, 0.97))
##//Model predictions
# plot_model(Rs_mod1, type = "pred", terms = c("Week", "Symbiont"), show.data = TRUE) + 
#   theme_bw()

##//Post-hoc hypothesis testing
HypRs_mod1 = hypothesis(
  Rs_mod1,
  hypothesis = c("Intercept = Intercept + SymbiontECM"))
HypRs_mod1

##//Post hoc tests
#get the adjusted means
Rs_mod1_em <- emmeans(Rs_mod1,  ~ Week)
Rs_mod1_em

#get all possible contrasts
cont <- contrast(Rs_mod1_em, "tukey")
cont


##//Hole density model
##//Random effect of site
Rs_plots$n_holes_f <- as.factor(Rs_plots$n_holes)
# Rs_mod2 <- brm(
#     Corr_LinFlux ~ n_holes * Symbiont + (1|Site),
#     data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
#     prior = my.prior,
#     family =  "normal",
#     iter = 2000,
#     chains = 4,
#     cores = 4,
#     control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(Rs_mod2, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/Rs_mod2.rda")
# rm(Rs_mod2)
##//Load Model output
load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/Rs_mod2.rda")

##//Model summaries
summary(Rs_mod2, prob = 0.94)
bayes_R2(Rs_mod2, prob = c(0.03, 0.97))
##//Model predictions
# plot_model(Rs_mod2, type = "pred", terms = c("n_holes", "Symbiont"), show.data = TRUE) + 
#   theme_bw()

##//Post-hoc hypothesis testing
HypRs_mod2 = hypothesis(
  Rs_mod2,
  hypothesis = c("Intercept = Intercept + SymbiontECM",
                 "0  =  n_holes "))
HypRs_mod2

#get the adjusted means
HypRs_mod2_em <- emmeans (Rs_mod2,  ~ n_holes | Symbiont)
HypRs_mod2_em

#need to figure out how to make this look all posterior-y
emmip(Rs_mod2,  ~ n_holes | Symbiont, CIs = TRUE, cov.reduce = range)


##//Hole density model
##//Random effect of site
Rs_plots$n_holes_f <- as.factor(Rs_plots$n_holes)
# Rs_mod3 <- brm(
#     Corr_LinFlux ~ n_holes_f * Symbiont + (1|Site),
#     data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
#     prior = my.prior,
#     family =  "normal",
#     iter = 2000,
#     chains = 4,
#     cores = 4,
#     control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(Rs_mod3, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/Rs_mod3.rda")
# rm(Rs_mod3)
##//Load Model output
load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/Rs_mod3.rda")
##//Model summaries
summary(Rs_mod3, prob = 0.94)
bayes_R2(Rs_mod3, prob = c(0.03, 0.97))

##//Post hoc tests
#get the adjusted means
HypRs_mod3_em <- emmeans (Rs_mod3,  ~ Symbiont | n_holes_f)
HypRs_mod3_em

#get all possible contrasts
cont <- contrast(HypRs_mod3_em, "tukey")
cont


HypRs_mod3_em <- emmeans (Rs_mod3,  ~ n_holes_f | Symbiont)
HypRs_mod3_em

#get all possible contrasts
cont <- contrast(HypRs_mod3_em, "tukey")
cont

#get the posterior draws from the contrasts
cont_posterior <- gather_emmeans_draws(cont)

#plot
ggplot(cont_posterior,
       aes(y = contrast, x = .value)) +
  geom_halfeyeh() +
  # facet_wrap(~wool) +
  geom_vline(xintercept = 0, color = "red", lty = 2)


ggplot(cont_posterior,
       aes(y = contrast, x = .value, fill = Symbiont  , group = Symbiont)) +
  geom_halfeyeh(alpha = 0.5)+
  geom_vline(xintercept = 0, color = "red", lty = 2)

#need to figure out how to make this look all posterior-y
emmip(Rs_mod3, ~ n_holes_f | Symbiont, CIs = TRUE, cov.reduce = range)


##//Model predictions
# plot_model(Rs_mod3, type = "pred", terms = c("n_holes_f", "Symbiont"), show.data = TRUE) + 
#   theme_bw()

##//Post-hoc hypothesis testing
# HypRs_mod3 = hypothesis(
#   Rs_mod3,
#   hypothesis = c("Intercept = Intercept + SymbiontECM"))
# HypRs_mod3

##//Symbiont model
##//Random effect of site
# Rs_plots$n_holes_f <- as.factor(Rs_plots$n_holes)
# Rs_mod4 <- brm(
#     Corr_LinFlux ~ Symbiont + (1|Site),
#     data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
#     prior = my.prior,
#     family =  "normal",
#     iter = 2000,
#     chains = 4,
#     cores = 4,
#     control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(Rs_mod4, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/Rs_mod4.rda")
# rm(Rs_mod4)
##//Load Model output
# load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/Rs_mod4.rda")

##//Model summaries
# summary(Rs_mod4, prob = 0.94)
# bayes_R2(Rs_mod4, prob = c(0.03, 0.97))
##//Model predictions
# plot_model(Rs_mod4, type = "pred", terms = c("Symbiont"), show.data = TRUE) + 
#   theme_bw()

##//Post-hoc hypothesis testing
# HypRs_mod4 = hypothesis(
#   Rs_mod4,
#   hypothesis = c("Intercept = Intercept + SymbiontECM"))
# HypRs_mod4
# 

##//Rs Symbiont plot
Rs_Sym_plot <- ggplot() +
  geom_boxplot(data = Rs_plots[Rs_plots$Corr_LinFlux<=6,],
               aes(x = as.factor(n_holes), y = Corr_LinFlux, fill = Symbiont), color = "black", 
               show.legend = TRUE,  size = 1, alpha = 0.4, position = position_dodge(0.5), 
               notch = TRUE, notchwidth = 0.7) +
  scale_color_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  scale_fill_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  xlab('Number of Holes') +
  # ylab(expression(paste("Soil Efflux  [", mu, "mol CO" [2], " m"^2, "  s "^-1, "] "  ))) +
  ylab(expression(paste("R" ["S"] , " [",mu, "mol " , " CO" ["2"], "  m"^"-2 ", "s"^"-1", "]"))) +
  annotate("text", x = as.factor(Rs_plots$n_holes[2]), y = 5, label = "a)    ", size = 20) +
  theme(legend.position="top",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species",size=30),
        legend.text=element_text(size=30))
Rs_Sym_plot


Rs_Sym_plot <- ggplot() +
  geom_violin(data = Rs_plots[Rs_plots$Corr_LinFlux<=6,],
               aes(x = as.factor(n_holes), y = Corr_LinFlux, fill = Symbiont), color = "black", 
               show.legend = TRUE,  size = 1, alpha = 0.4, position = position_dodge(0.5), 
               trim=FALSE) +
    geom_boxplot(data = Rs_plots[Rs_plots$Corr_LinFlux<=6,],
               aes(x = as.factor(n_holes), y = Corr_LinFlux, fill = Symbiont), color = "black", 
               show.legend = TRUE,  size = 1, alpha = 0.25, position = position_dodge(0.5),
               notch = T, notchwidth = 0.95) +
  
  scale_color_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  scale_fill_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  xlab('Number of Holes') +
  # ylab(expression(paste("Soil Efflux  [", mu, "mol CO" [2], " m"^2, "  s "^-1, "] "  ))) +
  ylab(expression(paste("R" ["S"] , " [",mu, "mol " , " CO" ["2"], "  m"^"-2 ", "s"^"-1", "]"))) +
  #annotate("text", x = as.factor(Rs_plots$n_holes[2]), y = 5, label = "a)    ", size = 20) +
  theme(legend.position="top",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species",size=30),
        legend.text=element_text(size=30))
Rs_Sym_plot 


Rs_Sym_plot2 <- ggplot() +
  geom_violin(data = Rs_plots[Rs_plots$Corr_LinFlux<=6,],
               aes(x = as.factor(n_holes), y = Corr_LinFlux, fill = Symbiont), color = "black", 
               show.legend = TRUE,  size = 1, alpha = 0.4, position = position_dodge(0.5), 
               trim=T) +
    geom_boxplot(data = Rs_plots[Rs_plots$Corr_LinFlux<=6,],
               aes(x = as.factor(n_holes), y = Corr_LinFlux, fill = Symbiont), color = "black", 
               show.legend = TRUE,  size = 1.5, alpha = 0.25, position = position_dodge(0.5),
               notch = F, notchwidth = 0.95) +
  
  scale_color_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  scale_fill_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  xlab('Number of Holes') +
  # ylab(expression(paste("Soil Efflux  [", mu, "mol CO" [2], " m"^2, "  s "^-1, "] "  ))) +
  ylab(expression(paste("R" ["S"] , " [",mu, "mol " , " CO" ["2"], "  m"^"-2 ", "s"^"-1", "]"))) +
  #annotate("text", x = as.factor(Rs_plots$n_holes[2]), y = 5, label = "a)    ", size = 20) +
  theme(legend.position="top",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species",size=30),
        legend.text=element_text(size=30))
Rs_Sym_plot2 


Rs_Sym_plot3 <- ggplot() +
  geom_violin(data = Rs_plots[Rs_plots$Corr_LinFlux<=6,],
               aes(x = as.factor(n_holes), y = Corr_LinFlux, fill = Symbiont), color = "black", 
               show.legend = TRUE,  size = 1, alpha = 0.4, position = position_dodge(0.8), 
               trim=T) +
    geom_boxplot(data = Rs_plots[Rs_plots$Corr_LinFlux<=6,],
               aes(x = as.factor(n_holes), y = Corr_LinFlux, fill = Symbiont), color = "black", 
               show.legend = TRUE,  size = 1.5, alpha = 0.25, position = position_dodge(0.8),
               notch = F, notchwidth = 0.95) +
  
  scale_color_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  scale_fill_manual(values = c("#4D54E8", "#ECC01D", "#A2A197"))+ 
  xlab('Number of Holes') +
  # ylab(expression(paste("Soil Efflux  [", mu, "mol CO" [2], " m"^2, "  s "^-1, "] "  ))) +
  ylab(expression(paste("R" ["S"] , " [",mu, "mol " , " CO" ["2"], "  m"^"-2 ", "s"^"-1", "]"))) +
  #annotate("text", x = as.factor(Rs_plots$n_holes[2]), y = 5, label = "a)    ", size = 20) +
  theme(legend.position="top",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species",size=30),
        legend.text=element_text(size=30))
Rs_Sym_plot3 


#################################################################
#################################################################

##//AM and EcM Scaler calculations
##//Zero holes
AM_0 <- median(Rs_plots$Corr_LinFlux[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Symbiont=="AM" & Rs_plots$n_holes==0])
ECM_0 <- median(Rs_plots$Corr_LinFlux[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Symbiont=="ECM" & Rs_plots$n_holes==0])
##//One hole 
AM_1 <- median(Rs_plots$Corr_LinFlux[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Symbiont=="AM" & Rs_plots$n_holes==1])
ECM_1 <- median(Rs_plots$Corr_LinFlux[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Symbiont=="ECM" & Rs_plots$n_holes==1])
##//Two holes
AM_2 <- median(Rs_plots$Corr_LinFlux[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Symbiont=="AM" & Rs_plots$n_holes==2])
ECM_2 <- median(Rs_plots$Corr_LinFlux[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Symbiont=="ECM" & Rs_plots$n_holes==2])

##//No fungal types
All_0 <- median(Rs_plots$Corr_LinFlux[Rs_plots$Corr_LinFlux<=6 & Rs_plots$n_holes==0])
All_1 <- median(Rs_plots$Corr_LinFlux[Rs_plots$Corr_LinFlux<=6 & Rs_plots$n_holes==1])
All_2 <- median(Rs_plots$Corr_LinFlux[Rs_plots$Corr_LinFlux<=6 & Rs_plots$n_holes==2])

abs(All_0 - All_1) / ((All_0 + All_1) / 2) * 100

abs(All_0 - All_2) / ((All_0 + All_2) / 2) * 100



##//All fungal types
AM <- median(Rs_plots$Corr_LinFlux[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Symbiont=="AM"])
ECM <- median(Rs_plots$Corr_LinFlux[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Symbiont=="ECM"])


Fun_Pdiff_1 <- abs(AM_0 - ECM_0) / ((AM_0 + ECM_0) / 2) * 100
Fun_Pdiff_1
##//AM Pct diff
AM_Pdiff_1 <- abs(AM_0 - AM_1) / ((AM_0 + AM_1) / 2) * 100
AM_Pdiff_1

AM_Pdiff_2 <- abs(AM_1 - AM_2) / ((AM_1 + AM_2) / 2) * 100
AM_Pdiff_2x <- abs(AM_0 - AM_2) / ((AM_0 + AM_2) / 2) * 100
AM_Pdiff_2x
##//EcM Pct diff
EcM_Pdiff_1 <- abs(ECM_0 - ECM_1) / ((ECM_0 + ECM_1) / 2) * 100
EcM_Pdiff_1
EcM_Pdiff_2 <- abs(ECM_1 - ECM_2) / ((ECM_1 + ECM_2) / 2) * 100
EcM_Pdiff_2x <- abs(ECM_0 - ECM_2) / ((ECM_0 + ECM_2) / 2) * 100
EcM_Pdiff_2x
###//percent gains based on the scaled fluxes 1 hole ~ 123 holes per m2
##                                            2 holes ~ 246 holes per m2
AM_1_scaler <- AM_Pdiff_1 / 123
AM_2_scaler <- AM_Pdiff_2 / 246

EcM_1_scaler <- EcM_Pdiff_1 / 123
EcM_2_scaler <- EcM_Pdiff_2 / 246

##//Average of the 1 and 2 hole estimates
##//Represents the CO2 increase per cicada hole
AM_scaler <- (AM_1_scaler + AM_2_scaler) / 2 
EcM_scaler <- (EcM_1_scaler + EcM_2_scaler) / 2

```
*Figure 3:* Soil respiration for cicada holes (**a)**) and seasonal trends (**b)**) with respect to the fungal type 

```{r fig.asp = 0.8, fig.width = 15, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
####///Rs Temp, and q10 models

# save(Rs_mod1, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/Rs_mod1.rda")
# rm(Rs_mod1)
##//Load Model output
#load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/Rs_mod1.rda")

##//Summarize data for each day and treatment
Rs_plots_sum <- Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",] %>%
  #dplyr::mutate(day = as.Date(Date_ct, format="%d-%m-%Y")) %>%
  dplyr::group_by(Date, Hole_Collar, Symbiont) %>% # group by the day column ##//mean looks good
  dplyr::summarise_if(is.numeric, median, na.rm = TRUE) %>%  
  na.omit

##//Summarize data for each day and treatment
Rs_plots_sum2 <- Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",] %>%
  #dplyr::mutate(day = as.Date(Date_ct, format="%d-%m-%Y")) %>%
  dplyr::group_by(Date, Pair, Hole_Collar, Symbiont) %>% # group by the day column ##//mean looks good
  dplyr::summarise_if(is.numeric, median, na.rm = TRUE) %>%  
  na.omit

formula <- bf(
  Corr_LinFlux ~ asym * exp(scale * SoilT_C),
  scale ~ 1,
  asym ~ 1,
  sigma ~ 1,
  nl = TRUE)
# quick and dirty priors. you need priors to even fit a model
##//Prior must be positive
prior1 <- c(
  prior(normal(0.2, 1), nlpar = "asym"),
  # the population average slope is constrained to be positive
  prior(normal(0.0699, 1), nlpar = "scale"))

# prior1 <- c(
#   prior(uniform(-10,10), nlpar = "asym"),
#   # the population average slope is constrained to be positive
#   prior(uniform(-10,10), nlpar = "scale"))


hist(Rs_plots_sum$Corr_LinFlux[Rs_plots_sum$Hole_Collar==0])

# fit_nohole <- brm(
#   formula,
#   data = Rs_plots_sum[Rs_plots_sum$Hole_Collar==0,],
#   prior = prior1,
#   family =  "normal",
#   iter = 8000,
#   chains = 4,
#   cores = 4,
#   control = list(adapt_delta = 0.90, max_treedepth = 15))

save(fit_nohole, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/fit_nohole.rda")
load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/fit_nohole.rda")
summary(fit_nohole, prob = 0.89)


####More Data approach
hist(log(Rs_plots_sum2$Corr_LinFlux[Rs_plots_sum2$Hole_Collar==0]))

plot(Rs_plots_sum2$Corr_LinFlux[Rs_plots_sum2$Hole_Collar==0] ~ Rs_plots_sum2$SoilT_C[Rs_plots_sum2$Hole_Collar==0])

# fit_nohole2 <- brm(
#   formula,
#   data = Rs_plots_sum2[Rs_plots_sum2$Hole_Collar==0,],
#   prior = prior1,
#   family =  "normal",
#   iter = 8000,
#   chains = 4,
#   cores = 4,
#   control = list(adapt_delta = 0.92, max_treedepth = 15))

save(fit_nohole2, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/fit_nohole2.rda")
load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/fit_nohole2.rda")
summary(fit_nohole2, prob = 0.89)

##//Calculate Q10
fit_nohole_ex <- prepare_predictions(fit_nohole)
survey_nohole_q10 <- exp(10 * fit_nohole_ex$nlpars$scale$fe$b)

median(survey_nohole_q10)
##//Calculate Q10
fit_nohole_ex2 <- prepare_predictions(fit_nohole2)
survey_nohole_q102 <- exp(10 * fit_nohole_ex2$nlpars$scale$fe$b)
median(survey_nohole_q102)

plot(density(survey_nohole_q10))
lines(density(survey_nohole_q102), col = "red")


# rm(fit_nohole)
# hist(Rs_plots_sum$Corr_LinFlux[Rs_plots_sum$Hole_Collar==1])
# fit_hole <- brm(
#   formula,
#   data = Rs_plots_sum[Rs_plots_sum$Hole_Collar==1,],
#   prior = prior1,
#   family =  "normal",
#   iter = 80000,
#   chains = 4,
#   cores = 4,
#   control = list(adapt_delta = 0.90, max_treedepth = 15))

#  save(fit_hole, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/fit_hole.rda")

load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/fit_hole.rda")
summary(fit_hole, prob = 0.89)

#########/

# fit_hole2 <- brm(
#   formula,
#   data = Rs_plots_sum2[Rs_plots_sum2$Hole_Collar==1,],
#   prior = prior1,
#   family =  "normal",
#   iter = 80000,
#   chains = 4,
#   cores = 4,
#   control = list(adapt_delta = 0.90, max_treedepth = 15))
# 
# save(fit_hole2, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/fit_hole2.rda")

load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/fit_hole2.rda")
summary(fit_hole2, prob = 0.89)

##//Calculate Q10
fit_hole_ex <- prepare_predictions(fit_hole)
survey_hole_q10 <- exp(10 * fit_hole_ex$nlpars$scale$fe$b)
median(survey_hole_q10)

##//Calculate Q10
fit_hole_ex2 <- prepare_predictions(fit_hole2)
survey_hole_q102 <- exp(10 * fit_hole_ex2$nlpars$scale$fe$b)
median(survey_hole_q102)

plot(density(survey_hole_q10))
lines(density(survey_hole_q102), col = "red")


###//New data for model predictions
new.data <- data.frame(SoilT_C = seq(min(Rs_plots$SoilT_C, na.rm = TRUE), 
                                     max(Rs_plots$SoilT_C, na.rm = TRUE), 
                                     length = 100))

##//Prediction Dataframes
##//Holes
holes_pred <- predict(fit_hole, newdata = new.data, probs = c(0.055, 0.945))
holes_pred_df <- as.data.frame(holes_pred)
holes_pred_df <-  cbind(holes_pred_df, new.data$SoilT_C); names(holes_pred_df)[5] <- "SoilT_C"
##//No Holes
nholes_pred <- predict(fit_nohole, newdata = new.data, probs = c(0.055, 0.945))
nholes_pred_df <- as.data.frame(nholes_pred)
nholes_pred_df <-  cbind(nholes_pred_df, new.data$SoilT_C); names(nholes_pred_df)[5] <- "SoilT_C"


##//Prediction Dataframes
##//Holes
holes_pred2 <- predict(fit_hole2, newdata = new.data, probs = c(0.055, 0.945))
holes_pred2_df <- as.data.frame(holes_pred2)
holes_pred2_df <-  cbind(holes_pred2_df, new.data$SoilT_C); names(holes_pred2_df)[5] <- "SoilT_C"
##//No Holes
nholes_pred2 <- predict(fit_nohole2, newdata = new.data, probs = c(0.055, 0.945))
nholes_pred2_df <- as.data.frame(nholes_pred2)
nholes_pred2_df <-  cbind(nholes_pred2_df, new.data$SoilT_C); names(nholes_pred2_df)[5] <- "SoilT_C"


Rs_plots_sum[Rs_plots_sum$Hole_Collar==0,]

myGray_1 <- grey.colors(4, start = 0.1, end = 0.9, gamma = 2.2, rev = FALSE)

cicadaColors <- c( "#191919", "#943b37" , "#fc0d03")
###//Plots
Rs_Ts_all <- ggplot() +
  geom_ribbon(data = holes_pred2_df, aes(x = SoilT_C, ymin = Q5.5, ymax = Q94.5), fill = cicadaColors[2],
              alpha = 0.1) +
  geom_line(data = holes_pred2_df, aes(x = SoilT_C, y = Estimate), color = cicadaColors[2], size = 5) +
  geom_ribbon(data = nholes_pred2_df, aes(x = SoilT_C, ymin = Q5.5, ymax = Q94.5), fill =  cicadaColors[1],
              alpha = 0.1) +
  geom_line(data = nholes_pred2_df, aes(x = SoilT_C, y = Estimate), color =  cicadaColors[1], size = 5) +
  geom_point(data = Rs_plots_sum2, aes(x = SoilT_C, y = Corr_LinFlux, color = as.factor(Hole_Collar), 
                                       shape =  as.factor(Hole_Collar)),
             show.legend = TRUE,  size = 5) +
  scale_color_manual(values = cicadaColors)+ 
  scale_fill_manual(values = cicadaColors)+ 
  xlab("Soil Temperature [C]") +
  # ylab(expression(paste("Soil Efflux  [", mu, "mol CO" [2], " m"^2, "  s "^-1, "] "  ))) +
  ylab(expression(paste("R" ["S"] , " [",mu, "mol " , " CO" ["2"], "  m"^"-2 ", "s"^"-1", "]"))) +
  annotate("text", x = 16, y = 5, label = "a)    ", size = 20) +
  annotate("text", x = 16.5, y = 4, label = "No Holes", size = 13) +
  annotate("text", x = 16.5, y = 3.5, label = "Holes     ", size = 13) +
  geom_point(aes(x = 15.2, y = 4), shape = 16, color = cicadaColors[1], size = 7) +
  geom_point(aes(x = 15.2, y = 3.5), shape = 17, color = cicadaColors[2], size = 7) +
  geom_point(aes(x = 15.2, y = 4), shape = "_", color = cicadaColors[1], size = 20) +
  geom_point(aes(x = 15.2, y = 3.5), shape = "_", color = cicadaColors[2], size = 20) +
  
  theme(legend.position = "NA",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species",size=30),
        legend.text=element_text(size=30))
Rs_Ts_all



Rs_Ts <- ggplot() +
  geom_ribbon(data = holes_pred_df, aes(x = SoilT_C, ymin = Q5.5, ymax = Q94.5), fill = GoAvsGo[2],
              alpha = 0.1) +
  geom_line(data = holes_pred_df, aes(x = SoilT_C, y = Estimate), color = GoAvsGo[2], size = 5) +
  geom_ribbon(data = nholes_pred_df, aes(x = SoilT_C, ymin = Q5.5, ymax = Q94.5), fill =  GoAvsGo[1],
              alpha = 0.1) +
  geom_line(data = nholes_pred_df, aes(x = SoilT_C, y = Estimate), color =  GoAvsGo[1], size = 5) +
  geom_point(data = Rs_plots_sum, aes(x = SoilT_C, y = Corr_LinFlux, color = as.factor(Hole_Collar)),
             show.legend = TRUE,  size = 5) +
  scale_color_manual(values = c("#943b37" , "#191919"))+ 
  scale_fill_manual(values = c("#943b37" , "#191919"))+ 
  xlab("Soil Temperature [C]") +
  # ylab(expression(paste("Soil Efflux  [", mu, "mol CO" [2], " m"^2, "  s "^-1, "] "  ))) +
  ylab(expression(paste("R" ["S"] , " [",mu, "mol " , " CO" ["2"], "  m"^"-2 ", "s"^"-1", "]"))) +
  annotate("text", x = 16, y = 3, label = "a)    ", size = 20) +
  theme(legend.position = "NA",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species",size=30),
        legend.text=element_text(size=30))


##//Q10 dataframe
Hole_data <- data.frame(Treatment = "Holes",
                     Q10 = sample(survey_hole_q102, size = 1000, replace = FALSE))
NoHole_data <- data.frame(Treatment = "No Holes",
                     Q10 = sample(survey_nohole_q102, size = 1000, replace = FALSE))

##//Combined
Q10_data <- rbind(Hole_data, NoHole_data)
Q10_data$Treatment <- as.factor(Q10_data$Treatment)

# ##//Are holes and no holes different
# my.prior <- set_prior("uniform(-30000,30000)", class = "b")
# ##//Model
# Q10_mod1 <- brm(
#     Q10 ~ Treatment,
#     data = Q10_data,
#     prior = my.prior,
#     family =  "normal",
#     iter = 2000,
#     chains = 4,
#     # cores = 4,
#     control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(Q10_mod1, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/Q10_mod1.rda")
load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/Q10_mod1.rda")
summary(Q10_mod1)

# my.prior <- set_prior("uniform(-30000,30000)", class = "b")
# ##//Model
# Q10_mod2 <- brm(
#     Q10 ~ Treatment,
#     data = Q10_data,
#     prior = my.prior,
#     family =  "normal",
#     iter = 2000,
#     chains = 4,
#     # cores = 4,
#     control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(Q10_mod2, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/Q10_mod2.rda")
load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/Q10_mod2.rda")
summary(Q10_mod2)

##//Test posteriors
# hypQ10 = hypothesis(
#   Q10_mod1,
#   hypothesis = c(
#     "Intercept = Intercept + TreatmentNoHoles"))
# hypQ10

##//Test posteriors
hypQ10 = hypothesis(
  Q10_mod2,
  hypothesis = c(
    "Intercept = Intercept + TreatmentNoHoles"))
hypQ10

##//Q10 plot
Q10Plot <- ggplot() +

  geom_violin(data = Q10_data, aes(y = Q10, x = Treatment, fill = Treatment), color = "black",
               show.legend = TRUE, trim = T, size = 1, alpha = 0.8) +
    geom_boxplot(data = Q10_data, aes(y = Q10, x = Treatment, fill = Treatment), color = "black",
               show.legend = TRUE,  size = 1.5, notch = F, notchwidth = 0.95,
               width = 0.5, alpha = 0.25) +
  xlab('Treatment') +
  ylab(expression(paste("R" ["S "],  "  Q" ["10 "] ))) +
    annotate("text", x = Q10_data$Treatment[1], y = 6, label = "b)             ", size = 20) +
  scale_color_manual(values = c( "#943b37" , "#191919")) +
  scale_fill_manual(values = c( "#943b37" , "#191919")) + 
  theme(legend.position= "NA",
        axis.text=element_text(size=30),
        axis.title=element_text(size=40),
        legend.title=element_text("Treatment",size=30),
        legend.text=element_text(size=30))


##Put plots together
# grid.arrange(
#   Rs_Ts,
#   Q10Plot,
#   ncol = 1,
#   nrow = 2,
#   # widths = c(3, 3),
#   # heights = c(3),
#   clip = FALSE
# )

#grey.colors(2, start = 0.3, end = 0.9, gamma = 2.2, alpha = 0.3, rev = FALSE)

grid.arrange(
  Rs_Ts_all,
  Q10Plot,
  ncol = 1,
  nrow = 2,
  # widths = c(3, 3),
  # heights = c(3),
  clip = FALSE
)

##//Export (1000 * 1500)
##//Percent Diff Q10
Hole_Q10 <- median(Q10_data$Q10[Q10_data$Treatment=="Holes"])
NoHole_Q10 <- median(Q10_data$Q10[Q10_data$Treatment=="No Holes"])

##//Q10 Pct diff
Q10_Pdiff <- abs(Hole_Q10 - NoHole_Q10) / ((Hole_Q10 + NoHole_Q10) / 2) * 100
Q10_Pdiff

```

*Figure 4:* The  soil temperature effects soil respiration (**a)**) for collars containing cicada holes (Blue) and no cicada holes (burgundy). Collars containing cicada holes are more sensitive to soil temperature (**b)**) as soil Q10  was significantly different between the two treatments.
  
  
  
 

## Spatially scaling of soil respiration and cicada emergence


  
#####             Region of interest: 

    
![Theortical footprint for cicada respirtation effects at Morgan-Monroe State Forest AmeriFlux site. Buffer represents a 20 m buffer (red polygon) surrounding each pair of soil respiration collars (points). ](D:/Dropbox/Projects/Indiana/Data/CicadaFlux/Figures/MMSF_projeted_2.png)

  
#### Mixed effects model for spatial interpolation 



```{r fig.asp = 0.8, fig.width = 15, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
####///Mixed effect model

# # ##//Model for spatial interpolation
# my.prior <- set_prior("uniform(-30000,30000)", class = "b")
# ##//Model
# names(Rs_plots)
# MEM_Mod1 <- brm(
#     Corr_LinFlux ~ SoilT_C + SoilVWC_pct + Latitude + Longitude + n_holes * Symbiont + (1|Site),
#     data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
#     prior = my.prior,
#     family =  "normal",
#     iter = 10000,
#     chains = 4,
#     cores = 4,
#     save_pars = save_pars(all = TRUE),
#     control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(MEM_Mod1, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/MEM_Mod1.rda")
# load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/MEM_Mod1.rda")
# summary(MEM_Mod1)

# MEM_Mod2 <- brm(
#     Corr_LinFlux ~ SoilT_C + SoilVWC_pct + n_holes * Symbiont + (1|Site),
#     data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
#     prior = my.prior,
#     family =  "normal",
#     iter = 40000,
#     chains = 4,
#     cores = 4,
#     save_pars = save_pars(all = TRUE),
#     control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(MEM_Mod2, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/MEM_Mod2.rda")
load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/MEM_Mod2.rda")
summary(MEM_Mod2)

# MEM_Mod3 <- brm(
#     Corr_LinFlux ~ SoilT_C + SoilVWC_pct + n_holes + Symbiont + (1|Site),
#     data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
#     prior = my.prior,
#     family =  "normal",
#     iter = 10000,
#     chains = 4,
#     cores = 4,
#     save_pars = save_pars(all = TRUE),
#     control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(MEM_Mod3, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/MEM_Mod3.rda")
# load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/MEM_Mod3.rda")
# summary(MEM_Mod3)

# MEM_Mod4 <- brm(
#     Corr_LinFlux ~ SoilT_C + n_holes + Symbiont + (1|Site),
#     data = Rs_plots[Rs_plots$Corr_LinFlux<=6 & Rs_plots$Site!="KentFarm",],
#     prior = my.prior,
#     family =  "normal",
#     iter = 10000,
#     chains = 4,
#     cores = 4,
#     save_pars = save_pars(all = TRUE),
#     control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(MEM_Mod4, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/MEM_Mod4.rda")
# load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/MEM_Mod4.rda")
# summary(MEM_Mod4)

# ##//Add model selection metrics
# MEM_Mod1_loo <- loo(MEM_Mod1, moment_match = TRUE) 
# MEM_Mod2_loo <- loo(MEM_Mod2, moment_match = TRUE) 
# MEM_Mod3_loo <- loo(MEM_Mod3, moment_match = TRUE) 
# MEM_Mod4_loo <- loo(MEM_Mod4, moment_match = TRUE) 
# 
# # compare both models
# loo_compare(MEM_Mod1_loo, MEM_Mod2_loo, MEM_Mod3_loo)


```
Model selection output
 Model: Corr_LinFlux ~ SoilT_C + SoilVWC_pct + n_holes * Symbiont + (1|Site)
###         elpd_diff se_diff
#### MEM_Mod2  0.0       0.0   
#### MEM_Mod1 -0.1       1.5   
#### MEM_Mod3 -2.5       2.3  


```{r fig.asp = 0.8, fig.width = 15, echo=FALSE}

##//Cicada holes by fungi type and site
# ##//Model for spatial interpolation
my.prior <- set_prior("uniform(-30000,30000)", class = "b")
meholes <- read.csv("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/CicadaData2021/MMSF_GW_CICADAHOLES_2021.csv")
##//Model
# holes_Mod1 <- brm(
#     Holes_mx ~ Fungi_Type + (1|Site),
#     data = meholes,
#     prior = my.prior,
#     family =  "normal",
#     iter = 10000,
#     chains = 4,
#     cores = 4,
#     save_pars = save_pars(all = TRUE),
#     control = list(adapt_delta = 0.90, max_treedepth = 15))
# summary(holes_Mod1)
# plot_model(holes_Mod1, type = "pred", terms = c("Fungi_Type"), show.data = TRUE) + 
#   theme_bw()
# save(holes_Mod1, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/holes_Mod1.rda")
load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/holes_Mod1.rda")
summary(holes_Mod1)


length(unique(meholes$Species[meholes$Site=="GW"]))
length(unique(meholes$Species[meholes$Site=="MMSF"]))

```



```{r fig.asp = 0.8, fig.width = 15, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

require(sf)
require(raster)
require(geoR)
require(INLA)
require(gstat)
require(fields)
require(rgdal)
library(tidyverse)
#library(spatstat)  # Used for the dirichlet tessellation function
library(maptools)  # Used for conversion from SPDF to ppp
library(raster)    # Used to clip out thiessen polygons
library(rgeos)
library(tmap)
library(gstat) # Use gstat's idw routine
library(sp)    # Used for the spsample function


###// Scalers based on fungal types
AM_scaler
EcM_scaler
##//Collar shapefiles
MMSF_pheno <- readOGR(dsn ="D:/Dropbox/Projects/Indiana/Data/CicadaFlux/GIS/MMSF_Cicada_Pheno", 
                       layer="PhenoHoles")
###//Plot boundary
MMSF_pheno_bound <- readOGR(dsn ="D:/Dropbox/Projects/Indiana/Data/CicadaFlux/GIS/MMSF_Cicada_Pheno", 
                            layer="PhenoHoles_Dissolve_15")

##//Converting holes to numeric
MMSF_pheno@data$Holes_mx <- as.numeric(as.character(MMSF_pheno@data$Holes_mx))
MMSF_pheno@data$Holes_mx_m2 <- MMSF_pheno@data$Holes_mx * 4 

MMSF_pheno@data$Species <- as.factor(as.character(MMSF_pheno@data$Species))
MMSF_pheno@data$Fungi_Type <- as.factor(as.character(MMSF_pheno@data$Fungi_Type))
MMSF_pheno@data$Fungi_Type_Scale[MMSF_pheno@data$Fungi_Type=="AM"] <- AM_scaler
MMSF_pheno@data$Fungi_Type_Scale[MMSF_pheno@data$Fungi_Type=="EcM"] <- EcM_scaler

##//Removing zero cicada hole measurements
MMSF_pheno@data$Holes_mx_m2_nzinf <- ifelse(MMSF_pheno@data$Holes_mx_m2==0, NA, MMSF_pheno@data$Holes_mx_m2) 

#//Have a look
plot(MMSF_pheno@data$Species, MMSF_pheno@data$Holes_mx_m2_nzinf)

plot(MMSF_pheno@data$Fungi_Type, MMSF_pheno@data$Holes_mx_m2_nzinf)

mod_data <- data.frame(Species = MMSF_pheno@data$Species,
                       Fungi = MMSF_pheno@data$Fungi_Type,
                       Holes_mx_m2 = MMSF_pheno@data$Holes_mx_m2_nzinf)

# ##//Model for spatial interpolation
# my.prior <- set_prior("uniform(-30000,30000)", class = "b")
##//Model
names(Rs_plots)
# hole_Mod1 <- brm(
#     Holes_mx_m2 ~ Fungi,
#     data = mod_data,
#     prior = my.prior,
#     family =  "lognormal",
#     iter = 10000,
#     chains = 4,
#     cores = 4,
#     save_pars = save_pars(all = TRUE),
#     control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(hole_Mod1, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/hole_Mod1.rda")
load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/hole_Mod1.rda")
summary(hole_Mod1)

length(mod_data$Species[mod_data$Fungi=="EcM"])
length(mod_data$Species[mod_data$Fungi=="AM"])

hist(log(mod_data$Holes_mx_m2))

##//Inverse distance weighted plots
P <- MMSF_pheno
W <- MMSF_pheno_bound

##//Update bounding box
P@bbox <- W@bbox

##//Create an empty grid where n is the total number of cells
grd              <- as.data.frame(spsample(P, "regular", n=500000))
names(grd)       <- c("X", "Y")
coordinates(grd) <- c("X", "Y")
gridded(grd)     <- TRUE  # Create SpatialPixel object
fullgrid(grd)    <- TRUE  # Create SpatialGrid object

##//Add P's projection information to the empty grid
proj4string(P) <- proj4string(P) # Temp fix until new proj env is adopted
proj4string(grd) <- proj4string(P)
# 
# grdx <- makegrid(P@coords, n = 3, nsig = 2, cellsize = 1, offset = rep(0.5, 2),
# 	pretty = TRUE)
# grdx
# 
# plot(grdx)
# image(r)
# points(spsample(P,n=1000,type="regular"), pch=3, cex=.5)
# 
# plot(spsample(P,n=1000,type="regular"))
# 
# points(pts@coords, col = "blue", pch = 16)


###//Interpolate the grid cells
P.idw <- gstat::idw(Fungi_Type ~ 1, P, newdata=grd, idp = 3.0)

###//Convert to raster object then clip to boundary
r <- raster(P.idw)
r_fungi <- r
r.m  <- mask(r, W)

##//Plot
tm_shape(r.m) + 
  tm_raster(palette = topo.colors(2), auto.palette.mapping = FALSE,
            title="AM (1) and EcM (2) Density") + 
  tm_shape(P) + tm_dots(size=1.2, col = "grey") +
  #legend.outside.size(5)+
  tm_legend(legend.outside=TRUE)

###//Cicada hole density
##############################################################################################
##//Interpolate the grid cells 
P.idw <- gstat::idw(Holes_mx_m2 ~ 1, P, newdata=grd, na.action = na.omit, idp = 3)
#P.idw <- gstat::idw(Symbiont ~ 1, P, newdata=grd, idp=4.0)

###//Convert to raster object then clip to boundary
r <- raster(P.idw)
r_holes <- r
r.m <- mask(r, W)

##//Plot
tm_shape(r.m) + 
  tm_raster(n=50,palette = topo.colors(10), auto.palette.mapping = FALSE,
            title="Cicada Hole per m2") + 
  tm_shape(P) + tm_dots(size=1.2, col = "white") +
  tm_legend(legend.outside=TRUE)


##//Hole Variation Model
##############################################################################################
##//Interpolate the grid cells
P.idw <- gstat::idw(Holes_mx_s^2 ~ 1, P, newdata=grd, idp = 10.0)

##//Convert to raster object then clip to boundary
r <- raster(P.idw)
r_holes_var <- r
r.m     <- mask(r, W)

##//Plot
tm_shape(r.m) + 
  tm_raster(n = 40,palette = topo.colors(8), auto.palette.mapping = FALSE,
            title="Cicada Hole Variation per Count") + 
  tm_shape(P) + tm_dots(size = 1.2, col = "white") +
  tm_legend(legend.outside=TRUE)


# driver_stack <- raster::stack(r_fungi, r_holes, r_holes_var)
# 
# 
# 
# plot(Rs_plots$Latitude[Rs_plots$Site=="MorganMonroe"]~ Rs_plots$Longitude[Rs_plots$Site=="MorganMonroe"])
# 
# 
# MMSF_collars <- readOGR(dsn ="D:/Dropbox/Projects/Indiana/Data/CicadaFlux/GIS", 
#                        layer="CicadaFluxCollars_MMSF")
# 
# 
# MMSF_collars
# 
# 
# MMSF_collars@coords
# MMSF_collars@proj4string <- CRS("+proj=aea +lat_0=40 +lon_0=-96 +lat_1=50 +lat_2=70 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs")
# 
# Q <- MMSF_collars
# Q@coords
# unique(Rs_plots$day[Rs_plots$Site=="MorganMonroe"])
Rs_plots_MMSF_1 <- Rs_plots[Rs_plots$Site=="MorganMonroe" & Rs_plots$day=="2021-06-11",]

names(Rs_plots_MMSF_1)
Rs_plots_MMSF_1h <- Rs_plots_MMSF_1[Rs_plots_MMSF_1$Hole_Collar==1 ,c(37, 51, 53, 61)]
Rs_plots_MMSF_1nh <- Rs_plots_MMSF_1[Rs_plots_MMSF_1$Hole_Collar==0 ,c(37, 51, 53, 61)]

Rs_plots_MMSF_1_11 <- merge(Rs_plots_MMSF_1h, Rs_plots_MMSF_1nh, by = c("Pair"))
names(Rs_plots_MMSF_1_11)[4] <- "Holes"; names(Rs_plots_MMSF_1_11)[7] <- "NoHoles" 

plot(Rs_plots_MMSF_1_11$Holes, Rs_plots_MMSF_1_11$NoHoles, 
     xlim = c(0,4), ylim = c(0,4), cex = 2, pch = 16, col = as.factor(Rs_plots_MMSF_1_11$Symbiont.x))
abline(0,1)



Rs_plots_MMSF_2 <- Rs_plots[Rs_plots$Site=="MorganMonroe" & Rs_plots$day=="2021-06-17",]

Rs_plots_MMSF_2h <- Rs_plots_MMSF_2[Rs_plots_MMSF_2$Hole_Collar==1 ,c(37, 51, 53, 61)]
Rs_plots_MMSF_2nh <- Rs_plots_MMSF_2[Rs_plots_MMSF_2$Hole_Collar==0 ,c(37, 51, 53, 61)]

Rs_plots_MMSF_2_11 <- merge(Rs_plots_MMSF_2h, Rs_plots_MMSF_2nh, by = c("Pair"))
names(Rs_plots_MMSF_2_11)[4] <- "Holes"; names(Rs_plots_MMSF_2_11)[7] <- "NoHoles" 

plot(Rs_plots_MMSF_2_11$Holes, Rs_plots_MMSF_2_11$NoHoles, 
     xlim = c(0,4), ylim = c(0,4), cex = 2, pch = 16, col = as.factor(Rs_plots_MMSF_2_11$Symbiont.x))
abline(0,1)


Rs_plots_MMSF_3 <- Rs_plots[Rs_plots$Site=="MorganMonroe" & Rs_plots$day=="2021-06-24",]

Rs_plots_MMSF_3h <- Rs_plots_MMSF_3[Rs_plots_MMSF_3$Hole_Collar==1 ,c(37, 51, 53, 61)]
Rs_plots_MMSF_3nh <- Rs_plots_MMSF_3[Rs_plots_MMSF_3$Hole_Collar==0 ,c(37, 51, 53, 61)]

Rs_plots_MMSF_3_11 <- merge(Rs_plots_MMSF_3h, Rs_plots_MMSF_3nh, by = c("Pair"))
names(Rs_plots_MMSF_3_11)[4] <- "Holes"; names(Rs_plots_MMSF_3_11)[7] <- "NoHoles" 

plot(Rs_plots_MMSF_3_11$Holes, Rs_plots_MMSF_3_11$NoHoles, 
     xlim = c(0,4), ylim = c(0,4), cex = 2, pch = 16, col = as.factor(Rs_plots_MMSF_3_11$Symbiont.x))
abline(0,1)


Rs_plots_MMSF_4 <- Rs_plots[Rs_plots$Site=="MorganMonroe" & Rs_plots$day=="2021-07-08",]

Rs_plots_MMSF_4h <- Rs_plots_MMSF_4[Rs_plots_MMSF_4$Hole_Collar==1 ,c(37, 51, 53, 61)]
Rs_plots_MMSF_4nh <- Rs_plots_MMSF_4[Rs_plots_MMSF_4$Hole_Collar==0 ,c(37, 51, 53, 61)]

Rs_plots_MMSF_4_11 <- merge(Rs_plots_MMSF_4h, Rs_plots_MMSF_4nh, by = c("Pair"))
names(Rs_plots_MMSF_4_11)[4] <- "Holes"; names(Rs_plots_MMSF_4_11)[7] <- "NoHoles" 

plot(Rs_plots_MMSF_4_11$Holes, Rs_plots_MMSF_4_11$NoHoles, 
     xlim = c(0,4), ylim = c(0,4), cex = 2, pch = 16, col = as.factor(Rs_plots_MMSF_4_11$Symbiont.x))
abline(0,1)



Rs_plots_MMSF_5 <- Rs_plots[Rs_plots$Site=="MorganMonroe" & Rs_plots$day=="2021-08-06",]

Rs_plots_MMSF_5h <- Rs_plots_MMSF_5[Rs_plots_MMSF_5$Hole_Collar==1 ,c(37, 51, 53, 61)]
Rs_plots_MMSF_5nh <- Rs_plots_MMSF_5[Rs_plots_MMSF_5$Hole_Collar==0 ,c(37, 51, 53, 61)]

Rs_plots_MMSF_5_11 <- merge(Rs_plots_MMSF_5h, Rs_plots_MMSF_5nh, by = c("Pair"))
names(Rs_plots_MMSF_5_11)[4] <- "Holes"; names(Rs_plots_MMSF_5_11)[7] <- "NoHoles" 

plot(Rs_plots_MMSF_5_11$Holes, Rs_plots_MMSF_5_11$NoHoles, 
     xlim = c(0,4), ylim = c(0,4), cex = 2, pch = 16, col = as.factor(Rs_plots_MMSF_5_11$Symbiont.x))
points(Rs_plots_MMSF_4_11$Holes, Rs_plots_MMSF_4_11$NoHoles, 
     xlim = c(0,4), ylim = c(0,4), cex = 2, pch = 16, col = as.factor(Rs_plots_MMSF_4_11$Symbiont.x))
points(Rs_plots_MMSF_3_11$Holes, Rs_plots_MMSF_3_11$NoHoles, 
     xlim = c(0,4), ylim = c(0,4), cex = 2, pch = 16, col = as.factor(Rs_plots_MMSF_3_11$Symbiont.x))
points(Rs_plots_MMSF_2_11$Holes, Rs_plots_MMSF_2_11$NoHoles, 
     xlim = c(0,4), ylim = c(0,4), cex = 2, pch = 16, col = as.factor(Rs_plots_MMSF_2_11$Symbiont.x))
points(Rs_plots_MMSF_1_11$Holes, Rs_plots_MMSF_1_11$NoHoles, 
     xlim = c(0,4), ylim = c(0,4), cex = 2, pch = 16, col = as.factor(Rs_plots_MMSF_1_11$Symbiont.x))
abline(0,1)

scaler
# 
# 
# plot(MMSF_collars)
# names(Rs_plots_MMSF_1)
# my.CRS <- MMSF_pheno@proj4string@projargs
# 
# 
# #//Put points into spatial points dataframe ie feature class
# pts <- SpatialPointsDataFrame(coords = Rs_plots_MMSF_1[57:56], data = Rs_plots_MMSF_1,
#                               proj4string = CRS("+proj=lcc +lat_0=41 +lon_0=-107.5 +lat_1=33 +lat_2=45 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs"))
# plot(pts)
# 
# pts@coords
# 
# #//Extract raster data from points
# e <- extract(r_holes,MMSF_collars@coords, df = TRUE)
# 
# #// Add the Extracted data to points
# dim(e)
# dim(pts)
# pts@data <- cbind(pts@data,e)
# dim(pts)
# View((pts))
# 
# 
# plot(driver_stack[[1]])
# plot(pts@coords, cex = pts@data$Corr_LinFlux , add = TRUE, col = "blue", pch = 16)
# 
# 
# 
# names(Rs_plots_MMSF_1)
# 
# 
# my.CRS <- MMSF_pheno@proj4string@projargs
# 
# Rs_plots_MMSF_1_shp <- st_as_sf(Rs_plots_MMSF_1, coords = c("Longitude", "Latitude"), crs = my.CRS)
# 
# plot(Rs_plots_MMSF_1_shp$geometry)
# ##//Update bounding box
# P@bbox <- W@bbox
# 
# ##//Create an empty grid where n is the total number of cells
# grd              <- as.data.frame(spsample(P, "regular", n=500000))
# names(grd)       <- c("X", "Y")
# coordinates(grd) <- c("X", "Y")
# gridded(grd)     <- TRUE  # Create SpatialPixel object
# fullgrid(grd)    <- TRUE  # Create SpatialGrid object
# 
# ##//Add P's projection information to the empty grid
# proj4string(P) <- proj4string(P) # Temp fix until new proj env is adopted
# proj4string(grd) <- proj4string(P)
# 

```


```{r fig.asp = 0.8, fig.width = 15, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
##//Getting me some packages
##//Package management
library(bigleaf)
library(tidybayes)
library(rstan)
library(brms)
library(modelr)
library(sjPlot)
library(sjstats)
library(RColorBrewer)
library(lubridate)
library(readxl)
library(tidyverse)
library(hutils)
library(dplyr)
library(plyr)
library(tidyr)
library(tidyselect)
library(stringr)
library(matrixStats)
library(knitr)
library(car)
library(corrplot)
library(hysteresis)
library(gridExtra)
library(ggpubr)
library(TreeDep)

theme_set(theme_minimal())
GoAvsGo <- c("#6F263D", "#236192", "#A2AAAD", "#000000")

##//Grab micromet data that we can clean psychrometers with respect to VPD
##//AmeriFlux download
dat_46m <- read.csv("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/AMF_US-MMS_BASE-BADM_21-5/AMF_US-MMS_BASE_HR_21-5.csv", 
                    skip = 2, na.strings = -9999)

names(dat_46m)

dat_46m$TIMESTAMP_END2 <- dat_46m$TIMESTAMP_END * 100
dat_46m$TIMESTAMP <- ymd_hms(dat_46m$TIMESTAMP_END2, tz = "EST")

##//Make if posixct
dat_46m$TIMESTAMP_ct <- as.POSIXct(strptime(dat_46m$TIMESTAMP, "%Y-%m-%d %H:%M"))

##//Convert to Hours 
dat_46m$Hours <- strptime(substr(dat_46m$TIMESTAMP_ct, 12, 16), "%H:%M")

##//Separating data into pre and cicada years
PreCicada <- dat_46m[dat_46m$TIMESTAMP_ct>"2011-01-01 00:00:00 EST" & dat_46m$TIMESTAMP_ct<"2021-01-01 00:00:00 EST",]
Cicada <- dat_46m[dat_46m$TIMESTAMP_ct>"2021-01-01 00:00:00 EST" & dat_46m$TIMESTAMP_ct<"2022-01-01 00:00:00 EST",]

PreCicada$doy <- as.numeric(strftime(PreCicada$TIMESTAMP_ct, format = "%j"))
Cicada$doy <- as.numeric(strftime(Cicada$TIMESTAMP_ct, format = "%j"))

##//Day when cicadas came out
#plot(Cicada$doy[Cicada$TS_2_1_1>=17.7], Cicada$TS_2_1_1[Cicada$TS_2_1_1>=17.7])

#unique(Cicada$doy[Cicada$TS_2_1_1>=17.7])
min(Cicada$doy[Cicada$TS_2_1_1>=17.7], na.rm = T)

##//QAQC filter using nighttinme data without extreme observations
cc <- PreCicada$FC_1_1_1> -50 & PreCicada$FC_1_1_1< 50 & PreCicada$USTAR_1_1_1>0.29 & PreCicada$PPFD_IN_1_1_1<5

d_pre = PreCicada[cc,] %>%
  #dplyr::mutate(TIMESTAMP_agg = floor_date(TIMESTAMP_ct, unit = "day"), ) %>%
  dplyr::group_by(doy) %>%
  dplyr::summarise_if(is.numeric, median, na.rm=T) 
min(d_pre$doy[d_pre$TS_2_1_1>=17.7], na.rm = T)

##//QAQC filter using nighttinme data without extreme observations
cc <- Cicada$FC_1_1_1> -50 & Cicada$FC_1_1_1< 50 & Cicada$USTAR_1_1_1>0.29 & Cicada$PPFD_IN_1_1_1<5
d_cicada = Cicada[cc,] %>%
#  dplyr::mutate(TIMESTAMP_agg = floor_date(TIMESTAMP_ct, unit = "day"), ) %>%
  dplyr::group_by(doy) %>%
  dplyr::summarise_if(is.numeric, median, na.rm=T) 

##//QAQC filter using nighttinme data without extreme observations
cc <- Cicada$FC_1_1_1> -50 & Cicada$FC_1_1_1< 50 & Cicada$USTAR_1_1_1>0.29 & Cicada$PPFD_IN_1_1_1<5
Cicada_sumz = Cicada[cc,]  %>% 
  dplyr::group_by(doy)  %>% 
  dplyr::summarize(FC_Std = sd(FC_1_1_1, na.rm = T), 
                   FC_Md = median(FC_1_1_1, na.rm = T),
                   ST_Std = sd(TS_2_1_1, na.rm = T), 
                   ST_Md = median(TS_2_1_1, na.rm = T)  )

##// Expanding upper and lower bounds of variation in both fluxes and soil moisture

Cicada_sumz$FC_UVar <- Cicada_sumz$FC_Md + Cicada_sumz$FC_Std
Cicada_sumz$FC_LVar <- Cicada_sumz$FC_Md - Cicada_sumz$FC_Std

Cicada_sumz$ST_UVar <- Cicada_sumz$ST_Md + Cicada_sumz$ST_Std
Cicada_sumz$ST_LVar <- Cicada_sumz$ST_Md - Cicada_sumz$ST_Std

##//QAQC filter using nighttinme data without extreme observations
cc <- PreCicada$FC_1_1_1> -50 & PreCicada$FC_1_1_1< 50 & PreCicada$USTAR_1_1_1>0.29 & PreCicada$PPFD_IN_1_1_1<5
PreCicada_sumz = PreCicada[cc,]  %>% 
  dplyr::group_by(doy)  %>% 
  dplyr::summarize(FC_Std = sd(FC_1_1_1, na.rm = T), 
                   FC_Md = median(FC_1_1_1, na.rm = T),
                   ST_Std = sd(TS_2_1_1, na.rm = T), 
                   ST_Md = median(TS_2_1_1, na.rm = T)  )

##// Expanding upper and lower bounds of variation in both fluxes and soil moisture
PreCicada_sumz$FC_UVar <- PreCicada_sumz$FC_Md + PreCicada_sumz$FC_Std
PreCicada_sumz$FC_LVar <- PreCicada_sumz$FC_Md - PreCicada_sumz$FC_Std

PreCicada_sumz$ST_UVar <- PreCicada_sumz$ST_Md + PreCicada_sumz$ST_Std
PreCicada_sumz$ST_LVar <- PreCicada_sumz$ST_Md - PreCicada_sumz$ST_Std

##// Eddy Flux figures
##// Day in which soil temperature reaches 68 F
##// Average == 149
##// 2021  == 144

##//Figure showing spring respiration 
RECO_EC <- ggplot() +
  geom_ribbon(data = PreCicada_sumz, aes(x = doy, ymin = FC_LVar, ymax = FC_UVar), fill = "grey70") + 
  geom_line(data = PreCicada_sumz, aes(x = doy, y = FC_Md), color = "black") + 
  geom_line(data = Cicada_sumz, aes(x = doy, y = FC_Md), color = "darkred", 
            size = 2) +

  geom_vline(xintercept = 149, col = "black", linetype = 2, size = 2) +
  geom_vline(xintercept = 140, col = "red", linetype = 2, size = 2) +

  xlab(expression(paste("Day of Year"))) +
  ylab(expression(paste("R" ["ECO"] , " [",mu, "mol " , " CO" ["2"], "  m"^"-2 ", "s"^"-1", "]"))) +
  ylim(-05,12)+
  xlim(50,200)+
  annotate("text", x = 100, y = -3, label = "2011-2020", color =  "grey70", size = 20) +
  annotate("text", x = 100, y = 7.5, label = "2021", color =  "darkred", size = 20) +
  
  #annotate("text", x = 3.5, y = 10.5, label = "camera", size = 10) +
  theme(legend.position = "NA",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species", size=30),
        legend.text=element_text(size=30)) 

RECO_EC 

Cicada_Comps <- inner_join(Cicada_sumz, PreCicada_sumz, by = "doy")

comp_data <- rbind(data.frame(Treatment = "PreCicada",
                        Flux = Cicada_Comps$FC_Md.y[Cicada_Comps$doy>50 & Cicada_Comps$doy<200], 
                        SoilT = Cicada_Comps$ST_Md.y[Cicada_Comps$doy>50 & Cicada_Comps$doy<200]),
                   data.frame(Treatment = "Cicada",
                        Flux = Cicada_Comps$FC_Md.x[Cicada_Comps$doy>50 & Cicada_Comps$doy<200],
                        SoilT = Cicada_Comps$ST_Md.x[Cicada_Comps$doy>50 & Cicada_Comps$doy<200]))

Cicada_effects <- lm(comp_data$Flux~ comp_data$Treatment)
summary(Cicada_effects)

Cicada_effects2 <- lm(comp_data$SoilT ~ comp_data$Treatment)
summary(Cicada_effects2)

##// No difference in FC between the 10 year mean and the cicada year
plot(Cicada_Comps$FC_Md.x[Cicada_Comps$doy>50 & Cicada_Comps$doy<200]~ 
     Cicada_Comps$FC_Md.y[Cicada_Comps$doy>50 & Cicada_Comps$doy<200])
abline(0,1)


##Next question: How about the Respiration sensitivity to temperature at the ecosystem scale
ggplot() +
  geom_ribbon(data = PreCicada_sumz, aes(x = ST_Md , ymin = FC_LVar, ymax = FC_UVar), fill = "grey70") + 
  geom_point(data = PreCicada_sumz, aes(x = ST_Md , y = FC_Md), color = "black") + 
  geom_point(data = Cicada_sumz, aes(x = ST_Md , y = FC_Md), color = "darkred", 
            size = 2) +
  
  geom_vline(xintercept = 149, col = "black", linetype = 2, size = 2) +
  geom_vline(xintercept = 144, col = "red", linetype = 2, size = 2) +
  
  xlab(expression(paste("Soil Temperature [C]"))) +
  ylab(expression(paste("R" ["ECO"] , " [",mu, "mol " , " CO" ["2"], "  m"^"-2 ", "s"^"-1", "]"))) +
  ylim(-05,12)+
  xlim(0, 25)+
  annotate("text", x = 80, y = -3, label = "2011-2020", color =  "grey70", size = 20) +
  annotate("text", x = 100, y = 7.5, label = "2021", color =  "darkred", size = 20) +
  
  #annotate("text", x = 3.5, y = 10.5, label = "camera", size = 10) +
  theme(legend.position = "NA",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species", size=30),
        legend.text=element_text(size=30)) 

formula <- bf(
  FC_Md ~ asym * exp(scale * ST_Md),
  scale ~ 1,
  asym ~ 1,
  sigma ~ 1,
  nl = TRUE)
# quick and dirty priors. you need priors to even fit a model
##//Prior must be positive
prior1 <- c(
  prior(normal(0.2, 1), nlpar = "asym"),
  # the population average slope is constrained to be positive
  prior(normal(0.0699, 1), nlpar = "scale"))

hist(log(PreCicada_sumz$FC_Md))
# 
# fit_PreCicada <- brm(
#   formula,
#   data = PreCicada_sumz,
#   prior = prior1,
#   family =  "lognormal",
#   iter = 10000,
#   chains = 3,
#   #cores = 4,
#   control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(fit_PreCicada, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/fit_PreCicada_RECO.rda")

load( file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/fit_PreCicada_RECO.rda")

summary(fit_PreCicada, prob = 0.89)
bayes_R2(fit_PreCicada, prob = c(0.055, 0.89))
plot_model(fit_PreCicada, type = "pred", terms = c("ST_Md"), show.data = TRUE) + 
theme_bw()

hist(log(Cicada_sumz$FC_Md[Cicada_sumz$FC_Md>0]))
# 
# fit_Cicada <- brm(
#   formula,
#   data = Cicada_sumz[Cicada_sumz$FC_Md>0,],
#   prior = prior1,
#   family =  "lognormal",
#   iter = 10000,
#   chains = 3,
#   #cores = 4,
#   control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(fit_Cicada, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/fit_Cicada_RECO.rda")
load(file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/fit_Cicada_RECO.rda")

summary(fit_Cicada, prob = 0.89)
bayes_R2(fit_Cicada, prob = c(0.055, 0.89))
plot_model(fit_Cicada, type = "pred", terms = c("ST_Md"), show.data = TRUE) + 
  theme_bw()


###//New data for model predictions
new.data <- data.frame(ST_Md = seq(min(PreCicada_sumz$ST_Md, na.rm = TRUE), 
                                     max(PreCicada_sumz$ST_Md, na.rm = TRUE), 
                                     length = 100))

##//Prediction Dataframes
##//Holes
holes_pred <- predict(fit_Cicada, newdata = new.data, probs = c(0.055, 0.945))
holes_pred_df <- as.data.frame(holes_pred)
holes_pred_df <-  cbind(holes_pred_df, new.data$ST_Md); names(holes_pred_df)[5] <- "ST_Md"
##//No Holes
nholes_pred <- predict(fit_PreCicada, newdata = new.data, probs = c(0.055, 0.945))
nholes_pred_df <- as.data.frame(nholes_pred)
nholes_pred_df <-  cbind(nholes_pred_df, new.data$ST_Md); names(nholes_pred_df)[5] <- "ST_Md"

class(nholes_pred_df)

plot(nholes_pred_df$Q94.5~ nholes_pred_df$SoilT_C)
##Next question: How about the Respiration sensitivity to temperature at the ecosystem scale
RECO_Q10_Fit <- ggplot() +

   geom_ribbon(data = holes_pred_df, aes(x = ST_Md , ymin = Q5.5, ymax = Q94.5),
              fill = "darkred", alpha = 0.25) + 
    geom_ribbon(data = nholes_pred_df, aes(x = ST_Md , ymin = Q5.5, ymax = Q94.5),
              fill = "grey70", alpha = 0.5) + 

  geom_point(data = PreCicada_sumz, aes(x = ST_Md , y = FC_Md), color = "black") +
  geom_point(data = Cicada_sumz, aes(x = ST_Md , y = FC_Md), color = "darkred",
            size = 2) +
  xlab(expression(paste("Soil Temperature [C]"))) +
  ylab(expression(paste("R" ["ECO"] , " [",mu, "mol " , " CO" ["2"], "  m"^"-2 ", "s"^"-1", "]"))) +
  ylim(0,17)+
  xlim(0, 25)+
  annotate("text", x = 2, y = 16, label = "a)", color =  "black", size = 20) +

  theme(legend.position = "NA",
        axis.text=element_text(size=30),
        axis.title=element_text(size=30),
        legend.title=element_text("Species", size=30),
        legend.text=element_text(size=30)) 
RECO_Q10_Fit

##//Calculate Q10
fit_cicada_ex <- prepare_predictions(fit_Cicada)
EC_cicada_q10 <- exp(10 * fit_cicada_ex$nlpars$scale$fe$b)

fit_Precicada_ex <- prepare_predictions(fit_PreCicada)
EC_Precicada_q10 <- exp(10 * fit_Precicada_ex$nlpars$scale$fe$b)


EC_Q10_d <- rbind(data.frame(Treatment = "Cicada Year",
                             Q10 = EC_cicada_q10),
                  data.frame(Treatment = "Ten Yr Avg",
                             Q10 = EC_Precicada_q10))
names(EC_Q10_d)[2] <- "Q10"

RECO_Q10 <- ggplot() +
  geom_violin(data = EC_Q10_d, aes(y = Q10, x = Treatment, fill = Treatment), color = "black",
               show.legend = TRUE,  size = 1, alpha = 0.7) +
  geom_boxplot(data = EC_Q10_d, aes(y = Q10, x = Treatment), color = "black",
              show.legend = FALSE,  size = 0.1, alpha = 0.1, varwidth = 0.2) +
  
  xlab('') +
  ylab(expression(paste("R" ["ECO "],  "Q" ["10 "] ))) +
  annotate("text", x = EC_Q10_d$Treatment[1], y = 4.6, label = "b)           ", size = 20) +
  #scale_color_manual(values = GoAvsGo) +
  scale_fill_manual(values = c("darkred", "grey70")) + 
  theme(legend.position= "NA",
        axis.text=element_text(size=30),
        axis.title=element_text(size=40),
        legend.title=element_text("Treatment",size=30),
        legend.text=element_text(size=30))
RECO_Q10



grid.arrange(
  RECO_Q10_Fit,
  RECO_Q10,
  ncol = 1,
  nrow = 2,
  # widths = c(3, 3),
  # heights = c(3),
  clip = FALSE
)

##//Per

##//Are Q10s different
my.prior <- set_prior("uniform(-30000,30000)", class = "b")
##//Model
# Q10_mod2 <- brm(
#     Q10 ~ Treatment,
#     data = EC_Q10_d,
#     prior = my.prior,
#     family =  "normal",
#     iter = 2000,
#     chains = 4,
#     # cores = 4,
#     control = list(adapt_delta = 0.90, max_treedepth = 15))
# save(Q10_mod2, file = "D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/Q10_mod2.rda")
load("D:/Dropbox/Projects/Indiana/Data/CicadaFlux/ModelSaves/Q10_mod2.rda")
summary(Q10_mod2)

##//Test posteriors
hypQ10 = hypothesis(
  Q10_mod2,
  hypothesis = c(
    "Intercept = Intercept + TreatmentCicadaYear"))
hypQ10




ggplot() +
  geom_violin(data = comp_data, aes(y = SoilT, x = Treatment, fill = Treatment), color = "black",
              show.legend = TRUE,  size = 1, alpha = 0.7) +
  geom_boxplot(data = comp_data, aes(y = SoilT, x = Treatment), color = "black",
               show.legend = FALSE,  size = 0.1, alpha = 0.1, varwidth = 0.2) +
  
  xlab('Treatment') +
  ylab(expression(paste("R" ["ECO "],  "Q" ["10 "] ))) +
  #  annotate("text", x = EC_Q10_d$Treatment[1], y = 6, label = "b)                ", size = 20) +
  #scale_color_manual(values = GoAvsGo) +
  scale_fill_manual(values = c("grey70", "darkred")) + 
  theme(legend.position= "NA",
        axis.text=element_text(size=30),
        axis.title=element_text(size=40),
        legend.title=element_text("Treatment",size=30),
        legend.text=element_text(size=30))


```


